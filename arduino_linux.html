
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

  <meta name="viewport" content="width=device-width,initial-scale=1">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <meta name="lang:clipboard.copy" content="Copy to clipboard">
  <meta name="lang:clipboard.copied" content="Copied to clipboard">
  <meta name="lang:search.language" content="en">
  <meta name="lang:search.pipeline.stopwords" content="True">
  <meta name="lang:search.pipeline.trimmer" content="True">
  <meta name="lang:search.result.none" content="No matching documents">
  <meta name="lang:search.result.one" content="1 matching document">
  <meta name="lang:search.result.other" content="# matching documents">
  <meta name="lang:search.tokenizer" content="[\s\-]+">

  
    <link href="https://fonts.gstatic.com/" rel="preconnect" crossorigin>
    <link href="https://fonts.googleapis.com/css?family=Roboto+Mono:400,500,700|Roboto:300,400,400i,700&display=fallback" rel="stylesheet">

    <style>
      body,
      input {
        font-family: "Roboto", "Helvetica Neue", Helvetica, Arial, sans-serif
      }

      code,
      kbd,
      pre {
        font-family: "Roboto Mono", "Courier New", Courier, monospace
      }
    </style>
  

  <link rel="stylesheet" href="_static/stylesheets/application.css"/>
  <link rel="stylesheet" href="_static/stylesheets/application-palette.css"/>
  <link rel="stylesheet" href="_static/stylesheets/application-fixes.css"/>
  
  <link rel="stylesheet" href="_static/fonts/material-icons.css"/>
  
  <meta name="theme-color" content="#3f51b5">
  <script src="_static/javascripts/modernizr.js"></script>
  
  
  
    <title>i.MX 8M Mini (Linux) to M4 (Arduino) comms &#8212; Portenta x8 notes  documentation</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/material.css" />
    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="_static/doctools.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Run apps on Linux side" href="run_apps.html" />
    <link rel="prev" title="Update Portenta x8 OS" href="update.html" />
  
   

  </head>
  <body dir=ltr
        data-md-color-primary=blue-grey data-md-color-accent=blue>
  
  <svg class="md-svg">
    <defs data-children-count="0">
      
      <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448" viewBox="0 0 416 448" id="__github"><path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg>
      
    </defs>
  </svg>
  
  <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer">
  <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search">
  <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
  <a href="#arduino_linux" tabindex="1" class="md-skip"> Skip to content </a>
  <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex navheader">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="index.html" title="Portenta x8 notes  documentation"
           class="md-header-nav__button md-logo">
          
            &nbsp;
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          <span class="md-header-nav__topic">Portenta x8 notes  documentation</span>
          <span class="md-header-nav__topic"> i.MX 8M Mini (Linux) to M4 (Arduino) comms </span>
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
        
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" action="search.html" method="get" name="search">
      <input type="text" class="md-search__input" name="q" placeholder="Search"
             autocapitalize="off" autocomplete="off" spellcheck="false"
             data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>

      </div>
      
      
  
  <script src="_static/javascripts/version_dropdown.js"></script>
  <script>
    var json_loc = ""versions.json"",
        target_loc = "../",
        text = "Versions";
    $( document ).ready( add_version_dropdown(json_loc, target_loc, text));
  </script>
  

    </div>
  </nav>
</header>

  
  <div class="md-container">
    
    
    
  <nav class="md-tabs" data-md-component="tabs">
    <div class="md-tabs__inner md-grid">
      <ul class="md-tabs__list">
          <li class="md-tabs__item"><a href="index.html" class="md-tabs__link">Portenta x8 notes  documentation</a></li>
      </ul>
    </div>
  </nav>
    <main class="md-main">
      <div class="md-main__inner md-grid" data-md-component="container">
        
          <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
            <div class="md-sidebar__scrollwrap">
              <div class="md-sidebar__inner">
                <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="index.html" title="Portenta x8 notes documentation" class="md-nav__button md-logo">
      
        <img src="_static/" alt=" logo" width="48" height="48">
      
    </a>
    <a href="index.html"
       title="Portenta x8 notes documentation">Portenta x8 notes  documentation</a>
  </label>
  

</nav>
              </div>
            </div>
          </div>
          <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
            <div class="md-sidebar__scrollwrap">
              <div class="md-sidebar__inner">
                
<nav class="md-nav md-nav--secondary">
    <label class="md-nav__title" for="__toc">Contents</label>
  <ul class="md-nav__list" data-md-scrollfix="">
        <li class="md-nav__item"><a href="#arduino-linux--page-root" class="md-nav__link">i.MX 8M Mini (Linux) to M4 (Arduino) comms</a><nav class="md-nav">
              <ul class="md-nav__list">
        <li class="md-nav__item"><a href="#linux-side" class="md-nav__link">Linux side</a><nav class="md-nav">
              <ul class="md-nav__list">
        <li class="md-nav__item"><a href="#python-msgpackrpc-python" class="md-nav__link">Python: msgpackrpc-python</a>
        </li></ul>
            </nav>
        </li>
        <li class="md-nav__item"><a href="#arduino-side" class="md-nav__link">Arduino side</a><nav class="md-nav">
              <ul class="md-nav__list">
        <li class="md-nav__item"><a href="#rpc" class="md-nav__link">RPC</a>
        </li>
        <li class="md-nav__item"><a href="#serialrpc" class="md-nav__link">SerialRPC</a>
        </li></ul>
            </nav>
        </li></ul>
            </nav>
        </li>
    
<li class="md-nav__item"><a class="md-nav__extra_link" href="_sources/arduino_linux.rst.txt">Show Source</a> </li>

<li id="searchbox" class="md-nav__item"></li>

  </ul>
</nav>
              </div>
            </div>
          </div>
        
        <div class="md-content">
          <article class="md-content__inner md-typeset" role="main">
            
  <section id="i-mx-8m-mini-linux-to-m4-arduino-comms">
<h1 id="arduino-linux--page-root">i.MX 8M Mini (Linux) to M4 (Arduino) comms<a class="headerlink" href="#arduino-linux--page-root" title="Permalink to this heading">¶</a></h1>
<p>The Portenta x8 communicates between the Arduino and Linux sides using the
<a class="reference external" href="https://github.com/arduino/portentax8-m4-proxy">m4-proxy</a> service running on
the x8’s Linux microPlaftorm.</p>
<p>The <cite>m4-proxy</cite> forwards RPC calls from the Arduino (M4) side from the M4 only to an RPC server running on localhost.</p>
<section id="linux-side">
<h2 id="linux-side">Linux side<a class="headerlink" href="#linux-side" title="Permalink to this heading">¶</a></h2>
<section id="python-msgpackrpc-python">
<h3 id="python-msgpackrpc-python">Python: msgpackrpc-python<a class="headerlink" href="#python-msgpackrpc-python" title="Permalink to this heading">¶</a></h3>
<p><a class="reference external" href="https://github.com/msgpack-rpc/msgpack-rpc-python">https://github.com/msgpack-rpc/msgpack-rpc-python</a></p>
<p><a class="reference external" href="https://pypi.org/project/msgpack-rpc-python/">https://pypi.org/project/msgpack-rpc-python/</a></p>
<p>Python library which hooks into the m4-proxy service.</p>
<p>Because the m4-proxy is running on the LMP, when running from container, need to
add the mapping <code class="docutils literal notranslate"><span class="pre">"x4-proxy:host-gateway"</span></code> in the container run config.</p>
<div class="literal-block-wrapper docutils container" id="id1">
<div class="code-block-caption"><span class="caption-text">docker run command</span><a class="headerlink" href="#id1" title="Permalink to this code">¶</a></div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">docker run --add-host"m4-proxy:host-gateway" demo-container</span>
</pre></div>
</div>
</div>
<div class="literal-block-wrapper docutils container" id="id2">
<div class="code-block-caption"><span class="caption-text">docker-compose.yml</span><a class="headerlink" href="#id2" title="Permalink to this code">¶</a></div>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">services</span><span class="p">:</span><span class="w"></span>
<span class="w">    </span><span class="nt">demo-container</span><span class="p">:</span><span class="w"></span>
<span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">demo-image</span><span class="w"></span>
<span class="w">        </span><span class="nt">extra_hosts</span><span class="p">:</span><span class="w"></span>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">"m4-proxy:host-gateway"</span><span class="w"></span>
</pre></div>
</div>
</div>
<p>Create an RPC client which sends to a server</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">msgpackrpc</span>

<span class="n">m4_proxy_register</span> <span class="o">=</span> <span class="n">msgpackrpc</span><span class="o">.</span><span class="n">Address</span><span class="p">(</span><span class="s1">'m4-proxy'</span><span class="p">,</span> <span class="mi">5000</span><span class="p">)</span>

<span class="n">client</span> <span class="o">=</span> <span class="n">msgpackrpc</span><span class="o">.</span><span class="n">Client</span><span class="p">(</span><span class="n">m4_proxy_register</span><span class="p">)</span>
<span class="n">hello</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="s2">"hello"</span><span class="p">)</span>

<span class="n">client</span> <span class="o">=</span> <span class="n">msgpackrpc</span><span class="o">.</span><span class="n">Client</span><span class="p">(</span><span class="n">m4_proxy_register</span><span class="p">)</span>  <span class="c1"># needs to be initialised for each client call</span>
<span class="n">world</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="s2">"world"</span><span class="p">)</span>
</pre></div>
</div>
<p>Create an RPC server which receives RPC calls</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">msgpackrpc</span>

<span class="c1"># create the RPC client</span>
<span class="n">m4_proxy_register</span> <span class="o">=</span> <span class="n">msgpackrpc</span><span class="o">.</span><span class="n">Address</span><span class="p">(</span><span class="s1">'m4-proxy'</span><span class="p">,</span> <span class="mi">5000</span><span class="p">)</span>
<span class="n">client</span> <span class="o">=</span> <span class="n">msgpackrpc</span><span class="o">.</span><span class="n">Client</span><span class="p">(</span><span class="n">m4_proxy_register</span><span class="p">)</span>

<span class="c1"># register script as RPC server listening on port 5015</span>
<span class="n">client</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="s1">'register'</span><span class="p">,</span> <span class="mi">5015</span><span class="p">,</span> <span class="p">[</span><span class="s1">'tty'</span><span class="p">])</span>

<span class="c1"># create</span>
<span class="k">class</span> <span class="nc">SerialRPC</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">"""Class that holds all implementations for the procedure the service exposes"""</span>

    <span class="k">def</span> <span class="nf">tty</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="sd">"""Special procedure called by the Arduino SerialRPC library"""</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">'</span><span class="si">{</span><span class="n">msg</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span><span class="si">}</span><span class="s1">'</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

<span class="k">try</span><span class="p">:</span>
    <span class="c1"># create RPC server and await incoming RPC calls</span>
    <span class="n">rpc_server</span> <span class="o">=</span> <span class="n">msgpackrpc</span><span class="o">.</span><span class="n">Server</span><span class="p">(</span><span class="n">SerialRPC</span><span class="p">())</span>
    <span class="n">rpc_server</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="n">msgpackrpc</span><span class="o">.</span><span class="n">Address</span><span class="p">(</span><span class="s2">"localhost"</span><span class="p">,</span> <span class="mi">5015</span><span class="p">))</span>
    <span class="n">rpc_server</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

<span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
    <span class="n">rpc_server</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
    <span class="n">rpc_server</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
</section>
</section>
<section id="arduino-side">
<h2 id="arduino-side">Arduino side<a class="headerlink" href="#arduino-side" title="Permalink to this heading">¶</a></h2>
<section id="rpc">
<h3 id="rpc">RPC<a class="headerlink" href="#rpc" title="Permalink to this heading">¶</a></h3>
<p>When you add the Portenta X8 to the Arduino IDE, it automatically adds the RPC library.
Documentation on this library doesn’t seem to be on the Arduino website though that
may change at some point.</p>
<p>Example usage (not tested so might be broken)</p>
<div class="highlight-arduino notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;RPC.h&gt;</span><span class="cp"></span>

<span class="kr">char</span><span class="w"> </span><span class="n">hello</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"HELLO"</span><span class="p">;</span><span class="w"></span>

<span class="kr">void</span><span class="w"> </span><span class="nb">setup</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">RPC</span><span class="p">.</span><span class="n">bind</span><span class="p">(</span><span class="s">"hello"</span><span class="p">,</span><span class="w"> </span><span class="p">[]{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">hello</span><span class="p">;</span><span class="w"> </span><span class="p">});</span><span class="w"></span>
<span class="w">    </span><span class="n">RPC</span><span class="p">.</span><span class="n">bind</span><span class="p">(</span><span class="s">"world"</span><span class="p">,</span><span class="w"> </span><span class="p">[]{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">world</span><span class="p">();</span><span class="w"> </span><span class="p">});</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kr">void</span><span class="w"> </span><span class="nb">loop</span><span class="p">()</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>

<span class="kr">char</span><span class="w"> </span><span class="nf">world</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="kr">char</span><span class="w"> </span><span class="n">world</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"WORLD!"</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">world</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>To call these bindings you’d use client.call(“hello”) on the Python side.</p>
</section>
<section id="serialrpc">
<h3 id="serialrpc">SerialRPC<a class="headerlink" href="#serialrpc" title="Permalink to this heading">¶</a></h3>
<p>When an Arduino Sketch includes the <code class="docutils literal notranslate"><span class="pre">&lt;SerialRPC.h&gt;</span></code> header, all the Serial calls
are actually RPC calls to the <code class="docutils literal notranslate"><span class="pre">tty</span></code> procedure, passing the string to print as parameter.</p>
<div class="highlight-arduino notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;SerialRPC.h&gt;</span><span class="cp"></span>

<span class="kr">void</span><span class="w"> </span><span class="nb">setup</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nf">Serial</span><span class="p">.</span><span class="nf">begin</span><span class="p">(</span><span class="mi">115200</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kr">void</span><span class="w"> </span><span class="nb">loop</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="nf">Serial</span><span class="p">.</span><span class="nf">println</span><span class="p">(</span><span class="s">"Hello world"</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="nf">delay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</section>
</section>
</section>


          </article>
        </div>
      </div>
    </main>
  </div>
  <footer class="md-footer">
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
          
            <a href="update.html" title="Update Portenta x8 OS"
               class="md-flex md-footer-nav__link md-footer-nav__link--prev"
               rel="prev">
              <div class="md-flex__cell md-flex__cell--shrink">
                <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
              </div>
              <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
                <span class="md-flex__ellipsis">
                  <span
                      class="md-footer-nav__direction"> Previous </span> Update Portenta x8 OS </span>
              </div>
            </a>
          
          
            <a href="run_apps.html" title="Run apps on Linux side"
               class="md-flex md-footer-nav__link md-footer-nav__link--next"
               rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title"><span
                class="md-flex__ellipsis"> <span
                class="md-footer-nav__direction"> Next </span> Run apps on Linux side </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink"><i
                class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          
        </a>
        
      </nav>
    </div>
    <div class="md-footer-meta md-typeset">
      <div class="md-footer-meta__inner md-grid">
        <div class="md-footer-copyright">
          <div class="md-footer-copyright__highlight">
              &#169; Copyright 2022, Joel Phillips.
              
          </div>
            Created using
            <a href="http://www.sphinx-doc.org/">Sphinx</a> 5.1.1.
             and
            <a href="https://github.com/bashtage/sphinx-material/">Material for
              Sphinx</a>
        </div>
      </div>
    </div>
  </footer>
  <script src="_static/javascripts/application.js"></script>
  <script>app.initialize({version: "1.0.4", url: {base: ".."}})</script>
  </body>
</html>